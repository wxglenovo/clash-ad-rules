name: Build AdGuardHome Rules from Shadowrocket

on:
  schedule:
    - cron: "0 */2 * * *"   # æ¯ä¸¤å°æ—¶è‡ªåŠ¨æ‰§è¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # âœ… Checkout ä»“åº“å¹¶ä½¿ç”¨ PAT é¿å… 403
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # âœ… ä¸‹è½½ Shadowrocket è§„åˆ™
      - name: Download Shadowrocket rules
        run: |
          mkdir -p tmp dist
          curl -L -o tmp/adblock_reject.txt https://raw.githubusercontent.com/REIJI007/AdBlock_Rule_For_Clash/main/adblock_reject.txt

      # âœ… è½¬æ¢ä¸º AdGuard Home æ ¼å¼å¹¶æ¸…ç†
      - name: Convert Shadowrocket to AdGuard Home
        run: |
          awk '!/^(\s*(!|\[|#)|$)/{print}' tmp/adblock_reject.txt > tmp/all_cleaned.txt
          sort tmp/all_cleaned.txt | uniq > tmp/all_deduped.txt

          # ç»Ÿè®¡
          RAW_COUNT=$(wc -l < tmp/all_cleaned.txt)
          DEDUP_COUNT=$(wc -l < tmp/all_deduped.txt)
          DUP_COUNT=$((RAW_COUNT - DEDUP_COUNT))

          TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S %Z')

          echo "åŸå§‹æ€»æ•°ï¼š$RAW_COUNT" | tee dist/old_rules.txt
          echo "å»é‡åï¼š$DEDUP_COUNT" | tee -a dist/old_rules.txt
          echo "é‡å¤è¡Œæ•°ï¼š$DUP_COUNT" | tee -a dist/old_rules.txt
          echo "æ›´æ–°æ—¶é—´ï¼š$TIMESTAMP" | tee -a dist/old_rules.txt

          # è¾“å‡ºæœ€ç»ˆ AdGuardHome.txt
          {
            echo "! ================================================================"
            echo "! ğŸ§© AdGuardHome è§„åˆ™ (ä» Shadowrocket è½¬æ¢)"
            echo "! æ›´æ–°æ—¶é—´ï¼š$TIMESTAMP"
            echo "! åŸå§‹è§„åˆ™æ•°ï¼š$RAW_COUNT"
            echo "! å»é‡åè§„åˆ™æ•°ï¼š$DEDUP_COUNT"
            echo "! ================================================================"
            cat tmp/all_deduped.txt
          } > dist/AdGuardHome.txt

          echo "$DEDUP_COUNT" > dist/line_count.txt

      # âœ… Commit & push
      - name: Commit Changes
        id: commit
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          PREV_COUNT=$(git show origin/main:dist/line_count.txt 2>/dev/null || echo 0)
          NEW_COUNT=$(cat dist/line_count.txt)
          NEW_ADDED=$((NEW_COUNT - PREV_COUNT))
          [ $NEW_ADDED -lt 0 ] && NEW_ADDED=0

          COMMIT_MSG="ğŸ§© æ›´æ–° AdGuardHome è§„åˆ™ï¼Œä» Shadowrocket è½¬æ¢ï¼Œæ–°å¢ ${NEW_ADDED} æ¡"

          git add dist/AdGuardHome.txt dist/old_rules.txt dist/line_count.txt
          if git diff --cached --quiet; then
            echo "no_change=true" >> $GITHUB_OUTPUT
            echo "No new rules to commit"
          else
            echo "no_change=false" >> $GITHUB_OUTPUT
            git commit -m "$COMMIT_MSG"
            git push https://x-access-token:${PAT_TOKEN}@github.com/${{ github.repository }} HEAD:main
            echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
            echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
            echo "new_added=$NEW_ADDED" >> $GITHUB_OUTPUT
          fi

      # âœ… Releaseï¼ˆå¯é€‰ï¼‰
      - name: Create or Update Release
        if: steps.commit.outputs.no_change == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.run_number }}"
          name: "ğŸ§© AdGuardHome Rules (from Shadowrocket)"
          body: |
            ${{ steps.commit.outputs.commit_message }}
            ---
            ğŸ“¦ æ–‡ä»¶åï¼šAdGuardHome.txt  
            ğŸ“Š æ€»è¡Œæ•°ï¼š${{ steps.commit.outputs.new_count }}  
            â• æ–°å¢ï¼š${{ steps.commit.outputs.new_added }} æ¡
          files: |
            dist/AdGuardHome.txt
            dist/old_rules.txt

      # âœ… è¾“å‡ºç»“æœ
      - name: Show Result
        run: |
          echo "================= âœ… è½¬æ¢å®Œæˆ ================="
          cat dist/old_rules.txt
          echo "------------------------------------------------------------"
          echo "ğŸ“ æ–‡ä»¶è·¯å¾„ï¼šdist/AdGuardHome.txt"
          echo "ğŸ“Š æ€»è¡Œæ•°ï¼š$(wc -l < dist/AdGuardHome.txt)"
          echo "------------------------------------------------------------"
          echo "å‰ 20 è¡Œç¤ºä¾‹ï¼š"
          head -n 20 dist/AdGuardHome.txt
          echo "============================================================"
