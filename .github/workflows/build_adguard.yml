name: Build AdGuardHome Rules

on:
  schedule:
    - cron: "0 */2 * * *"   # 每两小时执行一次
  workflow_dispatch:         # 支持手动触发

permissions:
  contents: write           # 允许 push

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # 使用默认 GITHUB_TOKEN

      - name: Create tmp and dist folders
        run: |
          mkdir -p tmp dist

      - name: Download Shadowrocket rules
        run: |
          curl -L -o tmp/adblock_reject.txt https://raw.githubusercontent.com/REIJI007/AdBlock_Rule_For_Clash/main/adblock_reject.txt

      - name: Convert to AdGuard Home format
        run: |
          python3 - <<'EOF'
          import re
          with open("tmp/adblock_reject.txt", "r", encoding="utf-8") as f:
              lines = f.readlines()
          converted = [l.strip() for l in lines if l.strip() and not l.startswith(("!", "[", "#"))]
          with open("dist/AdGuardHome.txt", "w", encoding="utf-8") as f:
              f.write("\n".join(converted))
          EOF

      - name: Generate stats
        run: |
          RAW_COUNT=$(wc -l < tmp/adblock_reject.txt)
          DEDUP_COUNT=$(wc -l < dist/AdGuardHome.txt)
          DUP_COUNT=$((RAW_COUNT - DEDUP_COUNT))
          TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S %Z')
          echo "原始总数：$RAW_COUNT" | tee dist/old_rules.txt
          echo "去重后：$DEDUP_COUNT" | tee -a dist/old_rules.txt
          echo "重复行数：$DUP_COUNT" | tee -a dist/old_rules.txt
          echo "更新时间：$TIMESTAMP" | tee -a dist/old_rules.txt
          echo "$DEDUP_COUNT" > dist/line_count.txt

      - name: Commit & Push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add dist/AdGuardHome.txt dist/old_rules.txt dist/line_count.txt
          git commit -m "🧩 Update AdGuardHome rules [skip ci]" || echo "No changes to commit"
          git push origin main

      - name: Create or Update Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.run_number }}"
          name: "🧩 AdGuardHome Rules"
          body: |
            更新 AdGuardHome 规则
            ---
            📦 文件名：AdGuardHome.txt  
            📊 总行数：$(wc -l < dist/AdGuardHome.txt)  
          files: |
            dist/AdGuardHome.txt
            dist/old_rules.txt

      - name: Show Result
        run: |
          echo "================= ✅ 合并完成 ================="
          cat dist/old_rules.txt
          echo "------------------------------------------------------------"
          echo "📁 文件路径：dist/AdGuardHome.txt"
          echo "📊 总行数：$(wc -l < dist/AdGuardHome.txt)"
          echo "------------------------------------------------------------"
          echo "前 20 行示例："
          head -n 20 dist/AdGuardHome.txt
          echo "============================================================"
