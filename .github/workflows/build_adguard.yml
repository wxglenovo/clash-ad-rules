name: Build AdGuardHome Rules

on:
  schedule:
    - cron: "0 */2 * * *"   # æ¯ä¸¤å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:         # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write           # å…è®¸ push

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # ä½¿ç”¨é»˜è®¤ GITHUB_TOKEN

      - name: Create tmp and dist folders
        run: |
          mkdir -p tmp dist

      - name: Download Shadowrocket rules
        run: |
          curl -L -o tmp/adblock_reject.txt https://raw.githubusercontent.com/REIJI007/AdBlock_Rule_For_Clash/main/adblock_reject.txt

      - name: Convert to AdGuard Home format
        run: |
          python3 - <<'EOF'
          import re
          with open("tmp/adblock_reject.txt", "r", encoding="utf-8") as f:
              lines = f.readlines()
          converted = [l.strip() for l in lines if l.strip() and not l.startswith(("!", "[", "#"))]
          with open("dist/AdGuardHome.txt", "w", encoding="utf-8") as f:
              f.write("\n".join(converted))
          EOF

      - name: Generate stats
        run: |
          RAW_COUNT=$(wc -l < tmp/adblock_reject.txt)
          DEDUP_COUNT=$(wc -l < dist/AdGuardHome.txt)
          DUP_COUNT=$((RAW_COUNT - DEDUP_COUNT))
          TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S %Z')
          echo "åŸå§‹æ€»æ•°ï¼š$RAW_COUNT" | tee dist/old_rules.txt
          echo "å»é‡åï¼š$DEDUP_COUNT" | tee -a dist/old_rules.txt
          echo "é‡å¤è¡Œæ•°ï¼š$DUP_COUNT" | tee -a dist/old_rules.txt
          echo "æ›´æ–°æ—¶é—´ï¼š$TIMESTAMP" | tee -a dist/old_rules.txt
          echo "$DEDUP_COUNT" > dist/line_count.txt

      - name: Commit & Push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add dist/AdGuardHome.txt dist/old_rules.txt dist/line_count.txt
          git commit -m "ğŸ§© Update AdGuardHome rules [skip ci]" || echo "No changes to commit"
          git push origin main

      - name: Create or Update Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.run_number }}"
          name: "ğŸ§© AdGuardHome Rules"
          body: |
            æ›´æ–° AdGuardHome è§„åˆ™
            ---
            ğŸ“¦ æ–‡ä»¶åï¼šAdGuardHome.txt  
            ğŸ“Š æ€»è¡Œæ•°ï¼š$(wc -l < dist/AdGuardHome.txt)  
          files: |
            dist/AdGuardHome.txt
            dist/old_rules.txt

      - name: Show Result
        run: |
          echo "================= âœ… åˆå¹¶å®Œæˆ ================="
          cat dist/old_rules.txt
          echo "------------------------------------------------------------"
          echo "ğŸ“ æ–‡ä»¶è·¯å¾„ï¼šdist/AdGuardHome.txt"
          echo "ğŸ“Š æ€»è¡Œæ•°ï¼š$(wc -l < dist/AdGuardHome.txt)"
          echo "------------------------------------------------------------"
          echo "å‰ 20 è¡Œç¤ºä¾‹ï¼š"
          head -n 20 dist/AdGuardHome.txt
          echo "============================================================"
