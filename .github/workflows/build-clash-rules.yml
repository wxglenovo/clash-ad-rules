name: Build Clash Rules

on:
  schedule:
    - cron: "0 0 * * *"     # æ¯å¤© 0 ç‚¹ UTCï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹ï¼‰
    - cron: "0 12 * * *"    # æ¯å¤© 12 ç‚¹ UTCï¼ˆåŒ—äº¬æ—¶é—´æ™šä¸Š 8 ç‚¹ï¼‰
  workflow_dispatch:         # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ ä¸‹è½½è§„åˆ™æº
      - name: Download rules
        run: |
          mkdir -p download
          echo "ğŸ”½ ä¸‹è½½è§„åˆ™..."
          curl -sSL --retry 5 https://raw.githubusercontent.com/DivineEngine/Profiles/master/Clash/Rules/adblock.txt > download/adblock.txt
          curl -sSL --retry 5 https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/pro.txt > download/hagezi-pro.txt
          # å¯æ·»åŠ è‡ªå®šä¹‰è§„åˆ™æº
          # curl -sSL --retry 5 https://raw.githubusercontent.com/ä½ çš„ç”¨æˆ·å/AdGuardHome-Filter/main/myrules.txt > download/myrules.txt

      # 3ï¸âƒ£ åˆ†ç±»å‹åˆå¹¶å»é‡
      - name: Merge & Dedup
        run: |
          echo "âš¡ åˆ†ç±»å‹å»é‡..."
          mkdir -p dist

          # åˆ†ç±»å‹å»é‡
          grep -E '^DOMAIN-SUFFIX' download/*.txt | sort -u > dist/domain-suffix.txt
          grep -E '^DOMAIN-KEYWORD' download/*.txt | sort -u > dist/domain-keyword.txt
          grep -E '^DOMAIN,' download/*.txt | sort -u > dist/domain.txt

          # ç”Ÿæˆå•ç‹¬ YAML æ–‡ä»¶
          for type in domain-suffix domain-keyword domain; do
            OUTPUT="dist/${type}.yaml"
            {
              echo "# =========================================="
              echo "# Clash å¹¿å‘Šè¿‡æ»¤è§„åˆ™ - ${type}"
              echo "# æ›´æ–°æ—¶é—´: $(date -u +%Y-%m-%d %H:%M:%S) UTC"
              echo "# æ¥æº: adblock, hagezi-pro ç­‰"
              echo "# =========================================="
              echo ""
            } > $OUTPUT
            cat dist/${type}.txt >> $OUTPUT
            echo "âœ… ç”Ÿæˆæ–‡ä»¶: $OUTPUT"
          done

          # ç”Ÿæˆå®Œæ•´åˆå¹¶æ–‡ä»¶
          OUTPUT="dist/merged-clash.yaml"
          {
            echo "# =========================================="
            echo "# Clash å¹¿å‘Šè¿‡æ»¤è§„åˆ™ - å…¨éƒ¨åˆå¹¶"
            echo "# æ›´æ–°æ—¶é—´: $(date -u +%Y-%m-%d %H:%M:%S) UTC"
            echo "# æ¥æº: adblock, hagezi-pro ç­‰"
            echo "# =========================================="
            echo ""
          } > $OUTPUT
          cat dist/domain-suffix.txt dist/domain-keyword.txt dist/domain.txt >> $OUTPUT
          echo "âœ… ç”Ÿæˆæ–‡ä»¶: $OUTPUT"

      # 4ï¸âƒ£ Commit & Pushï¼ˆä½¿ç”¨ PATï¼‰
      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add dist/*.yaml
          git commit -m "Update Clash rules $(date -u +%Y-%m-%d)" || echo "No changes to commit"

          # ä½¿ç”¨ PAT æ¨é€
          git remote set-url origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/wxglenovo/clash-ad-rules.git
          git push origin main

          # è‡ªåŠ¨æ‰“ tag
          git tag -fa "clash-rules-$(date -u +%Y-%m-%d)" -m "Clash rules updated $(date -u +%Y-%m-%d)"
          git push origin --tags
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
